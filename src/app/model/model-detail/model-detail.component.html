<!--
Copyright 2020-2022 University of Oxford
and Health and Social Care Information Centre, also known as NHS Digital

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

SPDX-License-Identifier: Apache-2.0
-->
<div class="modelDetails">
  <form name="form" (ngSubmit)="save()" disable-submit-on-enter>
    <div class="panel-body">
      <div class="full-width" style="clear: both" *ngIf="detail">
        <div class="details-menu">
          <button
            type="button"
            mat-stroked-button
            [matMenuTriggerFor]="userActions"
            class="secondary small"
          >
            <span class="fas fa-ellipsis-v"></span>
            <span style="display: none">Menu</span>
          </button>

          <!--First level Menu-->
          <mat-menu #userActions="matMenu" class="mdm--mat-menu--actions">
            <a
              mat-menu-item
              *ngIf="access.showFinalise"
              class="has-text-green"
              (click)="finalise()"
            >
              <span class="fas fa-check-circle has-text-green"></span>
              Finalise
            </a>
            <a
              mat-menu-item
              *ngIf="access.showEdit && !isEditing"
              (click)="showForm()"
            >
              <span class="fas fa-pencil-alt"></span> Edit Title
            </a>
            <a
              mat-menu-item
              data-cy="edit-branch-name"
              *ngIf="canChangeBranchName"
              (click)="editBranchName()"
            >
              <span class="fas fa-code-branch"></span> Edit Branch Name
            </a>
            <a
              mat-menu-item
              data-cy="edit-label"
              *ngIf="access.showEdit"
              (click)="openBulkEdit()"
            >
              <span class="fas fa-clone"></span> Bulk Edit
            </a>
            <a
              mat-menu-item
              data-cy="compare"
              [matMenuTriggerFor]="compareMenu"
              *ngIf="isAdministrator"
            >
              <span class="fas fa-balance-scale-right" aria-hidden="true"></span>
              Compare
            </a>

            <a
              mat-menu-item
              *ngIf="access.showNewVersion"
              (click)="newVersion()"
            >
              <span class="fas fa-copy"></span> Create a New Version
            </a>
            <a
              mat-menu-item
              *ngIf="access.canMergeInto"
              (click)="merge()"
            >
              <span class="fas fa-window-restore"></span> Merge...
            </a>
            <a mat-menu-item (click)="showMergeGraph()">
              <span class="fas fa-code-branch"></span> Merge graph
            </a>
            <mat-divider></mat-divider>
            <a
              mat-menu-item
              data-cy="restore"
              type="button"
              class="has-text-green"
              *ngIf="detail.deleted && isAdministrator"
              (click)="restore()"
            >
              <span class="fas fa-trash-restore has-text-green"></span> Restore
            </a>

            <a
              mat-menu-item
              [matMenuTriggerFor]="userActionsDelete"
              *ngIf="access.showSoftDelete || access.showPermanentDelete"
              class="warning"
            >
              <span class="fas fa-trash-alt warning"></span> Delete
            </a>
          </mat-menu>
          <!-- End of first level menu -->

          <!--Second level sub Menu-->
          <mat-menu #userActionsDelete="matMenu">
            <a
              mat-menu-item
              (click)="askForSoftDelete()"
              *ngIf="access.showSoftDelete && !detail.deleted"
            >
              <span class="fas fa-ban warning"></span>
              Mark as deleted
            </a>
            <a
              mat-menu-item
              (click)="askForPermanentDelete()"
              *ngIf="access.showPermanentDelete"
            >
              <span class="fas fa-trash-alt warning"></span>
              Delete <span class="warning">permanently</span>
            </a>
          </mat-menu>
          <!-- End of Second level sub Menu-->

        </div>

        <mat-menu #compareMenu="matMenu">
          <a mat-menu-item (click)="compare()" *ngIf="!detail?.deleted">
            Compare to another Data Model
          </a>
          <div
            *ngIf="compareToList && compareToList.length > 0"
            class="divider"
          ></div>
          <div *ngIf="compareToList && compareToList.length > 0">
            <div *ngFor="let el of compareToList">
              <button mat-menu-item (click)="compare(el)">
                <a
                >{{ el.label }}
                  <span style="font-style: italic; font-size: 12px">{{
                    el.documentationVersion
                    }}</span></a
                >
              </button>
            </div>
          </div>
        </mat-menu>
        <!-- End of second level sub menu -->


        <div
          *ngIf="access.showPermission"
          style="position: relative; float: right; margin-right: 8px"
          [hidden]="isEditing"
        >
          <button
            mat-stroked-button
            type="button"
            class="secondary small"
            (click)="showSecurityDialog()"
            matTooltip="User & Group Access"
            aria-label="User & Group Access"
          >
            <span class="fas fa-user-lock"></span>
          </button>
        </div>
        <div
          style="position: relative; float: right; margin-right: 8px"
          *ngIf="!isEditing && !processing"
        >
          <button
            mat-icon-button
            data-cy="export-menu"
            color="primary"
            type="button"
            *ngIf="isLoggedIn"
            class="paddingless"
            [disabled]="processing"
            matTooltip="Export as JSON, XML,..."
            aria-label="Export as JSON, XML,..."
            (click)="exportModel()"
          >
            <span class="fas fa-download"></span>
          </button>
        </div>

      </div>

      <div *ngIf="detail">
        <div class="data-model-header">

          <h4
            class="inline-block marginless"
            [ngClass]="[ detail?.deleted? 'deletedDataModelTitle':'']"
          >
            <span [ngClass]="[detail?.finalised?'finalised': 'draft']">
              <span class="dataModelTypeIcon">
                <mdm-element-icon [element]="detail"></mdm-element-icon>
              </span>
              <mdm-inline-text-edit
                [readOnly]="false"
                [inEditMode]="isEditing"
                [(ngModel)]="detail.label"
                [isRequired]="true"
                [showButtons]="true"
                (saveClicked)="save()"
                (cancelClicked)="cancel()"
                [name]="'moduleName'"
                size="20"
                [styleCss]="'dataModelDetailsLabel'"
              >
              </mdm-inline-text-edit>
              <sup
                *ngIf="detail?.readableByEveryone"
                class="text-muted"
                style="margin-left: 4px"
                ><i
                  class="fas fa-globe-europe globe fa-xs"
                  aria-hidden="true"
                  matTooltip="Publicly Available"
                ></i
              ></sup>
              <sup
                *ngIf="detail?.readableByAuthenticatedUsers"
                class="text-muted"
                style="margin-left: 4px"
                ><i
                  class="fas fa-users globe fa-xs"
                  aria-hidden="true"
                  matTooltip="Authenticated users only"
                ></i
              ></sup>
            </span>
            <mdm-favorite-button [catalogueItem]="detail">
            </mdm-favorite-button>
          </h4>
          <span class="inline-block" *ngIf="detail?.deleted">
            <small class="warning"> | Deleted</small>
          </span>

          <!--<mdm-element-status [result]="detail"></mdm-element-status> -->
        </div>
      </div>
      <div #modelVersion id="modelVersion">
        <dl *ngIf="detail?.modelVersion && detail?.finalised">
          <dt><span matTooltip="Model Version" class="fas fa-file-alt"></span>Version: </dt>
          <dd>
            <span *ngIf="detail.modelVersionTag" class="tag-name">
              <span>{{ detail.modelVersionTag }}</span>
              <span class="text-muted small">&nbsp;({{ detail.modelVersion }})</span>
            </span>
            <span *ngIf="!detail.modelVersionTag">{{ detail.modelVersion }}</span>
          </dd>
        </dl>
        <dl *ngIf="detail">
          <dt><span class="fas fa-code-branch" matTooltip="Branch name"></span>Branch: </dt>
          <dd>
            <mdm-branch-selector [catalogueItem]="detail"></mdm-branch-selector>
          </dd>
        </dl>

        <mat-expansion-panel #detailsPanel hideToggle="true" togglePosition="before">
          <mat-expansion-panel-header>
            <mat-panel-title ngClass="expandingPanelTitle">
              <span *ngIf="detailsPanel.expanded" class="fas fa-caret-down"
              aria-hidden="true"
              matTooltip="Hide additional details"></span>
              <span *ngIf="!detailsPanel.expanded" class="fas fa-caret-right"
                 aria-hidden="true"
                 matTooltip="Show additional details"></span>
              <span *ngIf="detailsPanel.expanded">Hide details</span>
              <span *ngIf="!detailsPanel.expanded">More details...</span>
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div>
          <dl>
            <dt><span class="fas fa-cube" matTooltip="Item type"></span>Item Type: </dt>
            <dd [textContent]="getItemType()"></dd>
          </dl>
          <dl>
            <dt><span class="fas fa-building" matTooltip="Authority"></span>Authority: </dt>
            <dd [textContent]="detail.authority.label"></dd>
          </dl>
          <dl *ngIf="detail?.readableByEveryone">
            <dt><span
              class="fas fa-globe-europe globe"
              aria-hidden="true"
              matTooltip="Availability"
            ></span>Availability: </dt>
            <dd>Publicly Readable</dd>
          </dl>
          <dl *ngIf="detail?.readableByAuthenticatedUsers">
            <dt><span
              class="fas fa-users globe"
              aria-hidden="true"
              matTooltip="Availability"
            ></span>Availability: </dt>
            <dd>Authenticated users only</dd>
          </dl>
          <dl *ngIf="detail?.documentationVersion">
            <dt><span matTooltip="Documentation Version" class="fas fa-copy"></span>Documentation Version: </dt>
            <dd>{{ detail.documentationVersion }}</dd>
          </dl>
          <dl *ngIf="detail">
            <dt><span class="far fa-calendar-alt" matTooltip="Last update"></span>Last update: </dt>
            <dd>{{ detail.lastUpdated | date: 'yyyy-MM-dd HH:mm:ss' }}</dd>
          </dl>
          </div>
        </mat-expansion-panel>
      </div>
    </div>
  </form>
</div>

<div style="clear: both" *ngIf="processing">
  <mat-progress-bar
    value="50"
    bufferValue="75"
    color="accent"
    mode="indeterminate"
  ></mat-progress-bar>
</div>
